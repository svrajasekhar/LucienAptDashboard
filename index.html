<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apartment Financial Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
.container{padding:12px;max-width:900px;margin:auto}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.kpi,.section{background:#fff;padding:12px;border-radius:8px}
.section{margin-top:14px}
.kpi small{display:block;font-size:12px;color:#666;margin-top:4px}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;background:#c0392b;color:#fff;font-size:12px;margin-left:6px}
.news-item{margin-bottom:10px}
.news-title{font-weight:bold}
.news-meta{font-size:12px;color:#555}
</style>
</head>
<body>
<div class="container">
<h2>Society Financial Dashboard</h2>

<div class="kpis">
  <div class="kpi">
    <b>Opening Balance</b><br>
    ₹<span id="opening"></span>
    <small>From: <span id="fromDate"></span></small>
  </div>
  <div class="kpi">
    <b>Closing Balance</b><br>
    ₹<span id="closing"></span>
    <small>As on: <span id="toDate"></span></small>
  </div>
  <div class="kpi"><b>Total Revenue</b><br>₹<span id="revenue"></span></div>
  <div class="kpi"><b>Total Expense</b><br>₹<span id="expense"></span></div>
</div>

<div class="section">
  <h3>Defaulters – Current Quarter <span class="badge" id="defaulterCount">0</span></h3>
  <div id="defaulters"></div>
</div>

<div class="section">
  <h3>Month-on-Month: Expense vs Projection</h3>
  <canvas id="momChart"></canvas>
</div>

<div class="section"><h3>Revenue Breakdown</h3><canvas id="revChart"></canvas></div>
<div class="section"><h3>Expense Breakdown</h3><canvas id="expChart"></canvas></div>

<div class="section">
  <h3>News & Issues</h3>
  <div id="news"></div>
</div>
</div>

<script>
const OPENING_BALANCE = 109379.56;
const MAINT_Q = 10500;
const MONTHLY_PROJECTION = 262000; // ₹2.62 lakh

function parseDate(d){
  if(!d) return null;
  const parsed = new Date(d);
  return isNaN(parsed) ? null : parsed;
}

Promise.all([
  fetch("data/transactions.json").then(r=>r.json()),
  fetch("data/apartments.json").then(r=>r.json()),
  fetch("data/news.json").then(r=>r.json())
]).then(([tx, apts, news]) => {

  let revenue = 0, expense = 0;
  let revMap = {}, expMap = {};
  let paid = {};
  let defaulters = [];
  let dates = [];
  let monthlyExpense = {};

  tx.forEach(t => {
    const dt = parseDate(t.Date);
    if (dt) {
      dates.push(dt);
      const key = dt.getFullYear() + "-" + (dt.getMonth()+1);
      monthlyExpense[key] = monthlyExpense[key] || 0;
    }

    const raw = t["Amount (₹)"];
    if (!raw) return;

    const amt = Number(String(raw).replace("₹","").replace(/,/g,""));
    if (isNaN(amt) || amt <= 0) return;

    const type = String(t.Type || "").toLowerCase().trim();
    const subCat = String(t["Sub-Category"] || "").toLowerCase().trim();

    if (type === "revenue") {
      revenue += amt;
      revMap[t.Category] = (revMap[t.Category] || 0) + amt;

      if (subCat === "maintenance fee") {
        const aptVal = t.apartment ?? t["Apt No"];
        if (aptVal !== undefined && aptVal !== "") {
          const aptKey = String(aptVal).trim();
          paid[aptKey] = (paid[aptKey] || 0) + amt;
        }
      }
    }

    if (type === "expense") {
      expense += amt;
      expMap[t.Category] = (expMap[t.Category] || 0) + amt;
      if (dt) {
        const key = dt.getFullYear() + "-" + (dt.getMonth()+1);
        monthlyExpense[key] += amt;
      }
    }
  });

  // Dates
  if (dates.length) {
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    document.getElementById("fromDate").innerText = minDate.toLocaleDateString("en-IN");
    document.getElementById("toDate").innerText = maxDate.toLocaleDateString("en-IN");
  }

  // KPIs
  document.getElementById("opening").innerText = Math.round(OPENING_BALANCE).toLocaleString("en-IN");
  document.getElementById("revenue").innerText = Math.round(revenue).toLocaleString("en-IN");
  document.getElementById("expense").innerText = Math.round(expense).toLocaleString("en-IN");
  document.getElementById("closing").innerText =
    Math.round(OPENING_BALANCE + revenue - expense).toLocaleString("en-IN");

  // Defaulters
  apts.forEach(obj => {
    const aptNo = String(obj.apartment).trim();
    if ((paid[aptNo] || 0) < MAINT_Q) defaulters.push(aptNo);
  });

  document.getElementById("defaulters").innerText =
    defaulters.length ? defaulters.join(", ") : "No defaulters";
  document.getElementById("defaulterCount").innerText = defaulters.length;

  // MOM Chart
  const months = Object.keys(monthlyExpense).sort();
  const expenseData = months.map(m => Math.round(monthlyExpense[m]));
  const projectionData = months.map(() => MONTHLY_PROJECTION);

  new Chart(document.getElementById("momChart"), {
    type: "bar",
    data: {
      labels: months,
      datasets: [
        { label: "Actual Expense", data: expenseData },
        { label: "Projected Expense", data: projectionData }
      ]
    }
  });

  new Chart(document.getElementById("revChart"), {
    type: "pie",
    data: { labels: Object.keys(revMap), datasets: [{ data: Object.values(revMap) }] }
  });

  new Chart(document.getElementById("expChart"), {
    type: "pie",
    data: { labels: Object.keys(expMap), datasets: [{ data: Object.values(expMap) }] }
  });

  const n = document.getElementById("news");
  news.forEach(x => {
    const div = document.createElement("div");
    div.className = "news-item";
    div.innerHTML = `
      <div class="news-title">${x.Title}</div>
      <div class="news-meta">Date: ${x.Date} | Status: ${x.Status || "N/A"}</div>
      <div>${x.Description || ""}</div>
    `;
    n.appendChild(div);
  });
});
</script>
</body>
</html>
